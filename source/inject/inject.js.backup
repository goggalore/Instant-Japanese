var positionX = 0;
var positionY = 0;

document.addEventListener('keyup', onKeyPress);
document.addEventListener('mousedown', getCoordinates);

function onKeyPress(event) {  
    var toggle = 'T'.charCodeAt();
    var selection = document.getSelection().toString();

    const MAX_LENGTH = 20;

    if(event.keyCode === toggle && selection !== '' && selection.length <= MAX_LENGTH) {
        chrome.runtime.sendMessage({searchTerm: selection}, createPopup);
    }

    return;
}

function getCoordinates(event) {
    positionX = event.pageX;
    positionY = event.pageY;
}

function createPopup(response) {
    var firstResult = response.data[0];
    var japaneseContent = {};
    var englishContent = {};
    var word = japaneseContent.word || japaneseContent.reading || '';

    var popup = document.createElement('div');
    var word = document.createElement('span');
    var reading = document.createElement('span');
    var partsOfSpeech = document.createElement('span');
    var jishoLink = document.createElement('span');
    var definitions = document.createElement('span');

    var displacementX = 25;
    var displacementY = 25;

    popup.className = 'IJpopup';
    popup.style.top = (positionY + displacementY).toString() + 'px';
    popup.style.left = (positionX - displacementX).toString() + 'px';  

    reading.className = 'IJcontent';
    reading.id = 'IJreading';

    if (firstResult === undefined) {
        reading.innerHTML = 'Couldn\'t find any definitions that match this word.';
        popup.appendChild(reading);
        document.body.appendChild(popup);
        document.addEventListener('mousedown', clearPopup);
        return;
    }

    japaneseContent = firstResult.japanese[0];
    englishContent = firstResult.senses[0];

    reading.innerHTML = japaneseContent.reading || ''; 

    word.className = 'IJcontent';
    word.id = 'IJword';
    word.innerHTML = japaneseContent.word || '';

    definitions.className = 'IJcontent';
    definitions.id = 'IJdefinitions';
    definitions.innerHTML = englishContent.english_definitions.join(', ') || '';

    partsOfSpeech.className = 'IJcontent';
    partsOfSpeech.id = 'IJpartsOfSpeech';
    partsOfSpeech.innerHTML = englishContent.parts_of_speech.join(', ') || '';

    jishoLink.className = 'IJcontent';
    jishoLink.id = 'IJjisho';
    jishoLink.innerHTML = 'jisho.org'
    jishoLink.setAttribute('href', 'jisho.org/search/' + encodeURIComponent(word));

    popup.style.height = (englishContent.english_definitions.join('').length/3 + 200).toString() + 'px';

    popup.appendChild(reading);
    popup.appendChild(word);
    popup.appendChild(definitions);
    popup.appendChild(partsOfSpeech);
    popup.appendChild(jishoLink);
    document.body.appendChild(popup);

    document.addEventListener('mousedown', clearPopup);
}

function clearPopup(event) {
    var popup = document.getElementsByClassName('IJpopup')[0];

    if(!isPopup(popup, event.target)){
        popup.remove();
        document.removeEventListener('mousedown', clearPopup);
        return;
    }

    return;
}

function isPopup (popupNode, node) {
    if (node === document || node === window) {
        return false;
    }

    if (node === popupNode) {
        return true;
    }

    return isPopup(popupNode, node.parentNode);
}

// TODO 
// don't allow multiple popups to be created when toggle is fired multiple times
// allow user to click through multiple definitions
// fix the jisho.org link not being clickable